{% extends "../base/base.html" %}
{% block title %}Index{% endblock %}

{% block template %}
{% include "../base/navbar.html" %}
{% load crispy_forms_tags %}
{{ form|as_crispy_errors }}


<style>
  .thumb-120 {
    width:80px; height:80px;
    border:1px solid #ddd; border-radius:6px;
    overflow:hidden; background:#f8f9fa;
    display:flex; align-items:center; justify-content:center;
    margin-top: 6px;
  }
  .thumb-120 img {
    width:100%; height:100%; object-fit:cover; display:block;
  }

  /* âœ… Force Dropzone to match 80Ã—80 */
  .dz-check-photo {
    width:80px !important;
    height:80px !important;
    min-width:80px !important;
    min-height:80px !important;
    max-width:80px !important;
    max-height:80px !important;

    border:2px dashed #ccc; border-radius:6px;
    background:#f9f9f9;
    display:flex; align-items:center; justify-content:center;
    text-align:center; color:#777; font-size:.8rem;
    padding:0;
    margin-top:6px;
  }

  /* Dropzoneâ€™s auto-generated preview box sometimes adds extra height */
  .dz-preview, .dz-message {
    margin:0 !important;
    padding:0 !important;
  }

  /* Align both columns top */
  .row.align-items-start .col-auto {
  display: flex;
  align-items: flex-end; /* aligns bottom edge with comment */
}
</style>

<div class="container">
  <div class="pt-5 mt-5"></div>
  <div class="row justify-content-center">
    <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-6">

        {% if messages %}
          <div class="mt-3">
            {% for message in messages %}
              <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show text-break" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
      {% endif %}
<div id="autosave-status" class="text-muted small mb-2" style="display:none;"></div>
<legend class="mb-3">Edit: {{ checklist.title }}</legend>



<div class="d-flex gap-2 mb-2">
  <a href="{% url 'checklist_dashboard' %}" class="btn btn-sm btn-outline-primary">
    Back to Dashboard
  </a>
</div>

{% if form.errors or form.non_field_errors or formset.non_form_errors or formset.errors %}
  <div class="alert alert-danger">
    <strong>Please fix the errors below.</strong>
    {% if form.non_field_errors %}<div>{{ form.non_field_errors }}</div>{% endif %}
    {% if formset.non_form_errors %}<div>{{ formset.non_form_errors }}</div>{% endif %}
  </div>
{% endif %}



<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form|crispy }}

  <h5 class="mt-4">Items</h5>
  {{ formset.management_form }}

  {% for f in formset %}
    <div class="card mb-3">
      <div class="card-body">
        {{ f.id }}
        {{ f.order }} {# hidden input - keep it here #}

        {% if f.non_field_errors or f.errors %}
          <div class="alert alert-warning py-2">
            {{ f.non_field_errors }}
            <pre class="small mb-0">{{ f.errors }}</pre>
          </div>
        {% endif %}

        <!-- Row 1: question (readonly) + result select -->
        <div class="row g-2 align-items-center">
          <div class="col-md-8">
            <div class="fw-semibold">{{ f.instance.text }}</div>
          </div>
          <div class="col-md-4">
            {{ f.result }}
          </div>
        </div>

        <!-- Row 2: comment (left) + image/dropzone (right) -->
        <div class="row g-2 align-items-start mt-2">
          <div class="col">
            {{ f.comment|as_crispy_field }}
          </div>

          <!-- Hide the built-in file input; uploads are separate -->
          <div class="d-none">{{ f.photo }}</div>

          <div class="col-auto">
            {% if f.instance.signed_url %}
              <a href="{{ f.instance.signed_url }}" target="_blank" class="thumb-120 d-inline-block" rel="noopener">
                <img src="{{ f.instance.signed_url }}" alt="photo">
              </a>
            {% else %}
              <div class="dropzone dz-check-photo"
                  data-upload-url="{% url 'upload_checklist_item_photo' slug=checklist.slug item_uuid=f.instance.uuid %}">
                <div class="dz-message small">Upload<br>Photo</div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-primary" name="action" value="save">Save Draft</button>
    <button class="btn btn-sm btn-outline-primary" name="action" value="submit">Submit & Generate PDF</button>
  </div>
</form>

</div>
</div>

<!-- Dropzone -->
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>

<script>
  if (window.Dropzone) Dropzone.autoDiscover = false;

  document.addEventListener('DOMContentLoaded', function () {
    const CSRF = getCookie('csrftoken');

    // â†“ Small helper: downscale to max 1600px, JPEG ~80%
    function downscaleImageFile(file, {maxDim=1600, quality=0.82} = {}) {
      return new Promise((resolve, reject) => {
        // If HEIC/HEIF (often not decodable in browser), skip transform
        if (!file.type.startsWith('image/') || /heic|heif/i.test(file.type)) {
          resolve(file);
          return;
        }
        const img = new Image();
        img.onload = () => {
          let {width:w, height:h} = img;
          if (w <= maxDim && h <= maxDim) {
            resolve(file); // already small
            URL.revokeObjectURL(img.src);
            return;
          }
          const ratio = Math.min(maxDim / w, maxDim / h);
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(w * ratio);
          canvas.height = Math.round(h * ratio);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(blob => {
            if (!blob) { resolve(file); return; }
            const name = file.name.replace(/\.\w+$/, '') + '.jpg';
            resolve(new File([blob], name, { type: 'image/jpeg' }));
          }, 'image/jpeg', quality);
          URL.revokeObjectURL(img.src);
        };
        img.onerror = () => reject(new Error('Image decode failed'));
        img.src = URL.createObjectURL(file);
      });
    }


    document.querySelectorAll('.dz-check-photo').forEach(function (el) {
      const url = el.getAttribute('data-upload-url');

      const dz = new Dropzone(el, {
        url: url,
        paramName: "file",
        maxFiles: 1,
        maxFilesize: 10,                       // MB
        acceptedFiles: "image/*,.heic,.heif",
        headers: { "X-CSRFToken": CSRF },
        previewsContainer: null,
        createImageThumbnails: false,          // âœ… save mobile CPU/RAM
        clickable: true,                       // âœ… tap anywhere to open picker
        timeout: 60 * 1000,                    // âœ… 60s network timeout

        // â†“ NEW: resize/compress before upload
        transformFile: async function (file, done) {
          try {
            console.log(`[Dropzone] Original file: ${file.name}, ${(file.size / 1024 / 1024).toFixed(2)} MB`);

            const optimized = await downscaleImageFile(file, { maxDim: 1600, quality: 0.82 });

            console.log(`[Dropzone] Optimized file: ${optimized.name}, ${(optimized.size / 1024 / 1024).toFixed(2)} MB`);

            done(optimized);
          } catch (err) {
            console.warn("[Dropzone] Resize failed, uploading original file:", err);
            done(file);
          }
        },

        init: function () {
          const ensureCameraHints = () => {
            if (this.hiddenFileInput) {
              this.hiddenFileInput.setAttribute("accept", "image/*,.heic,.heif");
              this.hiddenFileInput.setAttribute("capture", "environment"); // back camera
            }
          };

          // Apply hints at several lifecycle moments
          ensureCameraHints();
          this.on("addedfile", ensureCameraHints);
          this.on("processing", ensureCameraHints);

          this.on("maxfilesexceeded", function (file) {
            this.removeAllFiles();
            this.addFile(file);
          });

          this.on("success", function (file, resp) {
            if (resp && resp.url) {
              const dropzoneCol = el.closest('.col-auto');
              const row = el.closest('.row');

              const thumbCol = document.createElement('div');
              thumbCol.className = 'col-auto';
              thumbCol.innerHTML = `
                <a href="${resp.url}" target="_blank" class="thumb-120 d-inline-block" rel="noopener">
                  <img src="${resp.url}" alt="photo">
                </a>
              `;

              // Slight delay avoids layout twitch on some mobiles
              setTimeout(() => {
                row.insertBefore(thumbCol, dropzoneCol);
                dropzoneCol.remove(); // no editing after upload
              }, 0);
            } else {
              el.innerHTML = '<small class="text-danger">Upload finished but no URL returned.</small>';
            }
          });

          this.on("error", function (file, message) {
            alert(typeof message === 'string' ? message : 'Upload failed');
            this.removeFile(file);
          });
        }
      });
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>

<!-- Alert auto-dismiss -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const alerts = document.querySelectorAll(".alert");
    alerts.forEach(alert => {
      setTimeout(() => {
        alert.classList.add("fade");
        alert.classList.remove("show");
        setTimeout(() => {
          if (alert.parentNode) alert.parentNode.removeChild(alert);
        }, 500);
      }, 5000);
    });
  });
</script>

<script>
  (function () {
    const form = document.querySelector('form');
    if (!form) return;

    const CSRF = (typeof getCookie === 'function') ? getCookie('csrftoken') : null;
    const statusEl = document.getElementById('autosave-status');
    const actionUrl = (typeof form.action === 'string' && form.action) ? form.action : window.location.href;
    const AUTOSAVE_URL = actionUrl + (actionUrl.includes('?') ? '&' : '?') + 'autosave=1';
    let saveTimer = null;
    let inflight = false;

    // Show â€œlast saved â€¦â€ helper
    function showSavedAt(ts) {
      if (!statusEl) return;
      statusEl.style.display = '';
      statusEl.textContent = `ðŸ’¾ Draft auto-saved ${new Date(ts).toLocaleTimeString()}`;
    }

    // Fire the autosave
    async function doAutosave() {
      if (inflight) return; // donâ€™t pile up
      inflight = true;
      try {
        const fd = new FormData(form);
        const resp = await fetch(AUTOSAVE_URL, {
          method: 'POST',
          body: fd,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            ...(CSRF ? {'X-CSRFToken': CSRF} : {})
          },
          credentials: 'same-origin'
        });
        if (resp.ok) {
          const data = await resp.json().catch(() => ({}));
          showSavedAt(data.saved_at || Date.now());
        }
      } catch (e) {
        // silent fail is fine for drafts
        // console.warn('autosave failed', e);
      } finally {
        inflight = false;
      }
    }

    // Debounce on input/change
    const onChange = () => {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(doAutosave, 1500);
    };

    // Watch all inputs (incl. formset rows)
    form.querySelectorAll('input, textarea, select').forEach(el => {
      el.addEventListener('input', onChange, { passive: true });
      el.addEventListener('change', onChange, { passive: true });
    });

    // Save when the page is backgrounded (user puts phone down / switches apps)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') doAutosave();
    });

    // Donâ€™t double-post if they actually submit
    form.addEventListener('submit', () => {
      clearTimeout(saveTimer);
    });
  })();
</script>
{% endblock %}