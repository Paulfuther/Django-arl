{% load crispy_forms_tags %}
{% load static %}

<div x-data="emailComposer()" x-init="init()" class="container my-4">
  {% if draft_id %}<input type="hidden" id="draft-id" value="{{ draft_id }}">{% endif %}
  <input type="hidden" id="uploaded_file_urls" value='{{ attachment_urls|default:"[]"|safe }}'>

  <!-- Mode toggle -->
  <fieldset class="mb-3">
    <label class="me-3">
      <input type="radio" name="mode" id="email_mode_template" value="template" x-model="mode">
      Use Prebuilt Template
    </label>
    <label>
      <input type="radio" name="mode" id="email_mode_text" value="text" x-model="mode">
      Compose Message
    </label>
  </fieldset>

  <!-- Compose section -->
  <div x-show="mode === 'text'" id="compose-email-section" class="mb-4">
    <!-- Saved Drafts -->
    <div class="mb-3">
      <h6 class="text-muted mb-2">Saved Drafts</h6>
      <ul class="list-group">
        {% for d in drafts %}
          <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2">
            <div class="d-flex align-items-center">
              <!-- delete on the left -->
              <form method="post" action="{% url 'delete_draft_email' d.id %}" class="me-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-link p-0 text-danger" title="Delete draft"
                        onclick="return confirm('Delete this draft?');">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
              <!-- title (edit only) -->
              <a href="{% url 'edit_draft_email' d.id %}" class="text-decoration-none text-dark">
                {{ d.subject|default:"(No Subject)" }}
              </a>
              {% if d.id == draft_id %}
                <span class="badge bg-secondary ms-2">Editing</span>
              {% endif %}
            </div>
          </li>
        {% empty %}
          <li class="list-group-item text-muted small">No drafts saved yet.</li>
        {% endfor %}
      </ul>
    </div>

    <!-- AI helper -->
    <div id="ai-prompt-wrapper" class="mb-4">
      <label>Need help from AI?</label>
      <textarea x-model="aiPrompt" placeholder="Describe your message..." class="form-control mb-2"></textarea>
      <button type="button" class="btn btn-outline-secondary btn-sm" @click="generateAI" :disabled="loadingAI">
        <span x-show="loadingAI" x-cloak>‚è≥ Generating‚Ä¶</span>
        <span x-show="!loadingAI" x-cloak>Generate with AI</span>
      </button>

      <div x-show="aiMessage" class="mt-3" id="ai-generated-result">
        <label>AI Suggested Message</label>
        <textarea class="form-control" x-model="aiMessage"></textarea>
        <button class="btn btn-link btn-sm mt-1" @click="insertAI">‚¨áÔ∏è Insert into form</button>
      </div>
    </div>

    <!-- Compose fields -->
    <label>Subject</label>
    <input type="text" x-model="form.subject" class="form-control mb-2">
    <label>Message</label>
    <textarea x-model="form.message" class="form-control" rows="6"></textarea>
  </div>

  <!-- Template section -->
  <div x-show="mode === 'template'" id="template-email-section" class="mb-4">
    <label>Select Template</label>
    <select x-model="form.templateId" class="form-select" id="template-select">
    <option value="">-- Choose a template --</option>
    {% for value, label in email_form.fields.sendgrid_id.choices %}
      {% if value %}
        <option value="{{ value }}">{{ label }}</option>
      {% endif %}
    {% endfor %}
  </select>
  </div>

  <!-- Group (EMAIL) -->
  <label class="form-label">Select Group</label>
  <button type="button" id="toggle-email-group" class="dropdown-toggle-btn">Choose Group</button>
  <div id="email-groupBox" class="dropdown-box mb-3">
    {% for radio in email_form.selected_group %}
      <div class="dropdown-option">
        {{ radio.tag }} {{ radio.choice_label }}
      </div>
    {% empty %}
      <p class="text-muted px-3">No groups available for your employer.</p>
    {% endfor %}
  </div>

  <!-- Or Individuals (EMAIL) -->
  <label class="form-label">Or Select Individuals</label>
  <button type="button" id="toggle-email-user-dropdown" class="dropdown-toggle-btn">
    <span id="email-selected-summary-label" class="d-inline">Select Users</span>
  </button>
  <div id="email-user-dropdownBox" class="dropdown-box mb-3">
    <div class="px-3 mt-3 mb-2">
      <input type="text"
             name="search"
             class="form-control mb-2"
             placeholder="Search users..."
             hx-get="{% url 'search_users' %}"
             hx-trigger="keyup changed delay:200ms"
             hx-target="#email-user-checkbox-list"
             hx-include="[name='csrfmiddlewaretoken'], input[name='selected_users']:checked"
             autocomplete="off">
    </div>
    <div id="email-user-checkbox-list" class="text-muted small px-3">
      {% include "msg/partials/user_checkboxes.html" with users=email_form.fields.selected_users.queryset selected_ids=selected_ids summary_id="email-selected-summary" %}
          
    </div>
  </div>

  <!-- Attachments -->
  <div class="mb-3">
  <label>Upload Attachments</label>

  <!-- Dropzone target -->
  <div class="dz-attachments border p-3 text-muted"
       data-upload-url="{% url 'upload_attachment' %}">
    üìé Click or drop files here
  </div>

  <!-- Optional: simple list of added attachments -->
  <ul id="attachment-list" class="list-group mt-2"></ul>
</div>

  <!-- ACTIONS (below dropzone) -->
  <div class="d-flex gap-2 mt-2">
    <button class="btn btn-outline-primary mt-3" @click.prevent="submit">Send Email</button>
    <button class="btn btn-outline-primary mt-3" id="save-draft-btn" @click.prevent="saveDraft">Save Draft</button>
  </div>
</div>

<!-- Hidden backend form (posts to original route) -->
<form id="email-send-form" method="post" action="{% url 'comms' %}" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="form_type" value="email">
  <input type="hidden" name="email_mode" id="send-email_mode">
  <input type="hidden" name="subject" id="send-subject">
  <input type="hidden" name="message" id="send-message">
  <input type="hidden" name="sendgrid_id" id="send-templateId">
  <input type="hidden" name="selected_group" id="send-groupId">
  <input type="hidden" name="uploaded_file_urls" id="send-uploaded_file_urls">
  {% if draft_id %}<input type="hidden" name="draft_id" value="{{ draft_id }}">{% endif %}
</form>




<script>
function emailComposer() {
  return {
    mode: 'template',
    loadingAI: false,
    aiPrompt: '',
    aiMessage: '',
    form: { subject: '', message: '', templateId: '', groupId: '' },
    templates: [],
    groups:    [],

    init() {
      const subj = "{{ draft.subject|default:''|escapejs }}";
      const msg  = "{{ draft.message|default:''|escapejs }}";
      const mode = "{{ draft.mode|default:''|escapejs }}";
      const tmpl = "{{ draft.sendgrid_template|default:''|escapejs }}";
      const grp  = "{{ draft.selected_group|default:''|escapejs }}";
      const hasDraft = "{{ draft_id|default:''|escapejs }}";

      if (subj) this.form.subject = subj;
      if (msg)  this.form.message = msg;
      if (tmpl) this.form.templateId = tmpl;
      if (grp)  this.form.groupId = grp;

      // If editing a draft, default to compose mode
      this.mode = mode || (hasDraft ? 'text' : 'template');
    },

    // collect selected user IDs from the checkbox list
    getSelectedUserIds() {
      return Array.from(document.querySelectorAll('#email-user-dropdownBox .user-checkbox:checked'))
                  .map(el => el.value);
    },

    // find selected group value (from Django radios)
    getSelectedGroupId() {
      const g = document.querySelector('#email-groupBox input[name="selected_group"]:checked');
      return g ? g.value : '';
    },

    async saveDraft() {
      const fd = new FormData();
      fd.set('subject', this.form.subject);
      fd.set('message', this.form.message);
      fd.set('email_mode', this.mode);
      fd.set('sendgrid_id', this.form.templateId);
      fd.set('selected_group', this.getSelectedGroupId());
      const urlsEl = document.getElementById('uploaded_file_urls');
      if (urlsEl) fd.set('uploaded_file_urls', urlsEl.value);

      // include selected users (multiple)
      this.getSelectedUserIds().forEach(id => fd.append('selected_users', id));

      const draftId = document.getElementById('draft-id')?.value;
      if (draftId) fd.set('draft_id', draftId);

      fd.append('action', 'save');

      try {
        const res = await fetch("{% url 'save_draft_ajax' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': getCSRFToken() },
          body: fd
        });
        const data = await res.json();
        if (data.success) {
          alert('‚úÖ Draft saved!');
          window.location.href = `/comms/?tab=email&draft_id=${data.draft_id}`;
        } else {
          alert('‚ùå Save failed: ' + (data.error || 'unknown'));
        }
      } catch (e) {
        console.error(e);
        alert('‚ùå Network error saving draft.');
      }
    },

    submit() {
      // fill hidden form
      document.getElementById('send-email_mode').value = this.mode;
      document.getElementById('send-subject').value    = this.form.subject;
      document.getElementById('send-message').value    = this.form.message;
      document.getElementById('send-templateId').value = this.form.templateId;
      document.getElementById('send-groupId').value    = this.getSelectedGroupId();
      document.getElementById('send-uploaded_file_urls').value =
        document.getElementById('uploaded_file_urls').value;

      // inject selected_users as multiple hidden inputs (fresh each time)
      const sendForm = document.getElementById('email-send-form');
      // clean previous clones
      sendForm.querySelectorAll('input[name="selected_users"]').forEach(n => n.remove());
      this.getSelectedUserIds().forEach(id => {
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = 'selected_users';
        inp.value = id;
        sendForm.appendChild(inp);
      });

      sendForm.submit(); // posts to original 'comms' route
    },

    async generateAI() {
      if (!this.aiPrompt.trim()) return alert('Enter a prompt first.');
      this.loadingAI = true;
      try {
        const res = await fetch("{% url 'generate_ai_content' %}", {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCSRFToken() },
          body: JSON.stringify({ prompt: this.aiPrompt, mode: 'email' })
        });
        const data = await res.json();
        this.aiMessage = data.message || '';
      } catch (e) {
        console.error(e);
        alert('AI error.');
      } finally {
        this.loadingAI = false;
      }
    },

    insertAI() { this.form.message = this.aiMessage; }
  }
}

function getCSRFToken() {
  const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : '';
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // open/close dropdowns
  function wireDropdown(toggleSel, boxSel) {
    const btn = document.querySelector(toggleSel);
    const box = document.querySelector(boxSel);
    if (!btn || !box) return;
    btn.addEventListener('click', () => {
      box.classList.toggle('open');
      btn.classList.toggle('open');
    });
  }
  wireDropdown('#toggle-email-group', '#email-groupBox');
  wireDropdown('#toggle-email-user-dropdown', '#email-user-dropdownBox');

  // update "X users selected"
  function updateSummary() {
    const checked = document.querySelectorAll('#email-user-dropdownBox .user-checkbox:checked');
    const label = document.getElementById('email-selected-summary-label');
    if (label) {
      const n = checked.length;
      label.textContent = n ? `${n} user${n===1?'':'s'} selected` : 'Select Users';
    }
  }
  document.addEventListener('change', (e) => {
    if (e.target && e.target.classList.contains('user-checkbox')) updateSummary();
  });
  document.addEventListener('htmx:afterSwap', (e) => {
    if (e.detail.target.id === 'email-user-checkbox-list') updateSummary();
  });
  updateSummary();
});
</script>

<script>
  // Reuse your existing CSRF helper
  function getCSRFToken() {
    const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : '';
  }

  if (window.Dropzone) Dropzone.autoDiscover = false;

  document.addEventListener('DOMContentLoaded', function () {
    const CSRF = getCSRFToken();

    document.querySelectorAll('.dz-attachments').forEach(function (el) {
      const url = el.getAttribute('data-upload-url');
      const dz = new Dropzone(el, {
        url: url,
        headers: { 'X-CSRFToken': CSRF },
        paramName: 'file',
        clickable: true,
        maxFilesize: 15, // MB
        timeout: 60 * 1000,
        // allow common docs + images; tweak as needed
        acceptedFiles: "image/*,.pdf,.doc,.docx,.xls,.xlsx,.csv,.txt",
        previewsContainer: null, // no preview grid; we append to a list on success

        init: function () {
          this.on('success', function (file, resp) {
            try {
              if (resp && resp.success && resp.url) {
                // Update the hidden JSON array
                const hidden = document.getElementById('uploaded_file_urls');
                let arr = [];
                try { arr = JSON.parse(hidden.value || '[]'); } catch (e) {}
                arr.push(resp.url);
                hidden.value = JSON.stringify(arr);

                // Show a simple attachment entry
                const list = document.getElementById('attachment-list');
                if (list) {
                  const li = document.createElement('li');
                  li.className = 'list-group-item py-1 small';
                  li.innerHTML = `<a href="${resp.url}" target="_blank" rel="noopener">${file.name}</a>`;
                  list.appendChild(li);
                }
              } else {
                alert('Upload finished but no URL returned.');
              }
            } finally {
              // Remove file from Dropzone UI (we keep only our list)
              this.removeFile(file);
            }
          });

          this.on('error', function (file, message) {
            alert(typeof message === 'string' ? message : 'Upload failed.');
            this.removeFile(file);
          });
        }
      });
    });
  });
</script>