<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css">
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script src="https://unpkg.com/pica@8.0.0/dist/pica.min.js"></script>

<style>

  .dropdown-toggle-btn.open::after {
    transform: rotate(180deg);
    content: "‚ñ≤";
  }

  .dropdown-box {
    border: 1px solid #ccc;
    border-top: none;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transition: max-height 0.4s ease, opacity 0.4s ease;
    background: white;
    padding: 0;
  }

  .dropdown-box.open {
    max-height: 400px; /* adjust if needed */
    opacity: 1;
    padding: 8px 0;
  }

  .custom-upload {
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f9f9f9;
  padding: 6px;
  font-size: 14px;
}

  .checkbox-group label {
    display: block;
    margin-bottom: 4px;
  }

 
</style>


<form id="template-email-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="hidden" name="form_type" value="email" />
  <input type="hidden" name="uploaded_file_urls" id="uploaded_file_urls">
    {% if messages %}
    <div class="mt-3">
      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
    {% endif %}
    {% if email_form.non_field_errors %}
  {% for error in email_form.non_field_errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {{ error }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}
<div id="template-email-spinner" class="mt-3 text-center" style="display: none;">
  <span class="dot-loader"><span></span><span></span><span></span></span>
  <div class="text-muted small mt-1">Sending your email‚Ä¶</div>
</div>
  <legend class="border-bottom mb-3">Send Email Template</legend>

          <!-- Template Selection -->
        <button type="button" id="toggle-template-dropdown" class="dropdown-toggle-btn">Select Template</button>

        <div id="template-dropdownBox" class="dropdown-box mb-3">
          {% for radio in email_form.sendgrid_id %}
            <div class="dropdown-option">
              {{ radio.tag }} {{ radio.choice_label }}
            </div>
          {% endfor %}
        </div>

        <!-- Group Selection -->
        <button type="button" id="toggle-template-group" class="dropdown-toggle-btn">Select Group</button>

        <div id="template-groupBox" class="dropdown-box mb-3">
          {% for radio in email_form.selected_group %}
            <div class="dropdown-option">
              {{ radio.tag }} {{ radio.choice_label }}
            </div>
          {% endfor %}
        </div>

          <!-- User Selection -->
          <button type="button" id="toggle-user-dropdown" class="dropdown-toggle-btn">
            <span id="selected-summary-label" class="d-inline">Select Users</span>
          </button>

          <div id="user-dropdownBox" class="dropdown-box mb-3">

            <!-- üîç Search Input -->
            <div class="px-3 mb-2">
            <input type="text"
                  name="search"
                  class="form-control mb-2"
                  placeholder="Search users..."
                  hx-get="{% url 'search_users' %}"
                  hx-trigger="keyup changed delay:200ms"
                  hx-target="#user-checkbox-list"
                  hx-include="[name='csrfmiddlewaretoken'], input[name='selected_users']:checked"
                  autocomplete="off">
            </div>
            
            <!-- üîÅ Live Result Target -->
            <div id="user-checkbox-list">
             <!-- Template Email -->
             {% include "msg/partials/user_checkboxes.html" with users=email_form.fields.selected_users.queryset selected_ids=selected_ids summary_id="selected-summary" %}
            </div>

          </div>
          <!-- Attachment Uploads -->
        <div id="upload-size-warning" class="text-muted small mt-2">
          <fieldset class="mb-4">
            <legend class="fs-6 fw-semibold text-secondary mb-2">
              üìé Upload Files
            </legend>
            <p class="text-muted small mb-1">
              You can upload <strong>up to 5 files</strong>. Total combined size must not exceed <strong>25 MB</strong>.
            </p>
            <div class="text-muted small">
              <strong>Total uploaded:</strong>
              <span id="upload-total-size" class="fw-bold text-dark">0</span> MB / 25 MB
            </div>
          </fieldset>
        </div>
        <div id="image-dropzone" class="dropzone" data-url="{% url 'upload_attachment' %}"></div>
        <ul id="upload-file-list" class="list-unstyled mt-2 text-muted small"></ul>
        <button type="submit" class="btn btn-outline-primary mt-3">Send Email</button>
      </form>



<!-- Setup all the dropdowns  -->
<script>
          document.addEventListener("DOMContentLoaded", function () {
          
            // === üîΩ Dropdown Setup (Template, Group, Users) ===
            function initDropdown(toggleSelector, boxSelector, inputType = "radio") {
              const toggleBtn = document.querySelector(toggleSelector);
              const box = document.querySelector(boxSelector);
          
              if (!toggleBtn || !box) return;
          
              toggleBtn.addEventListener("click", function () {
                box.classList.toggle("open");
                toggleBtn.classList.toggle("open");
              });
          
              box.querySelectorAll(`input[type=${inputType}]`).forEach(input => {
                input.addEventListener("change", () => {
                  if (inputType === "radio") {
                    const label = input.closest(".dropdown-option")?.textContent.trim();
                    toggleBtn.textContent = label || "Select";
                    box.classList.remove("open");
                    toggleBtn.classList.remove("open");
                  } else if (inputType === "checkbox") {
                    const selected = Array.from(box.querySelectorAll('input[type=checkbox]:checked'))
                      .map(cb => cb.closest(".dropdown-option")?.textContent.trim())
                      .join(", ");
                      updateSelectedSummary();;
                  }
                });
              });
            }
          
            // ‚úÖ Hook up dropdowns
            initDropdown("#toggle-template-dropdown", "#template-dropdownBox", "radio");
            initDropdown("#toggle-template-group", "#template-groupBox", "radio");
            initDropdown("#toggle-user-dropdown", "#user-dropdownBox", "checkbox");
          
            // === ‚òëÔ∏è "Select All" for user checkboxes ===
            const selectAll = document.getElementById("select-all-users");
            const userCheckboxes = document.querySelectorAll(".user-checkbox");
          
            if (selectAll && userCheckboxes.length > 0) {
              selectAll.addEventListener("change", function () {
                userCheckboxes.forEach(cb => cb.checked = this.checked);
              });
            }
          
            // === üìé Attachment Validation + Spinner ===
            const form = document.getElementById("template-email-form");
            const fileInput = document.querySelector('#template-email-form input[type="file"][name="attachments"]');
          
            if (form && fileInput) {
              form.addEventListener("submit", function (e) {
                if (form.dataset.submitted) {
                  e.preventDefault();
                  return;
                }
          
                const files = fileInput.files;
                const maxFiles = 5;
                const maxSize = 10 * 1024 * 1024;
          
                if (files.length > maxFiles) {
                  alert(`‚ùå You can upload up to ${maxFiles} files.`);
                  e.preventDefault();
                  return;
                }
          
                for (let file of files) {
                  if (file.size > maxSize) {
                    alert(`‚ùå ${file.name} exceeds the 10MB size limit.`);
                    e.preventDefault();
                    return;
                  }
                }
          
                // ‚úÖ Valid ‚Äî Show spinner and block resubmit
                form.dataset.submitted = true;
          
                const spinner = document.getElementById("template-email-spinner");
                if (spinner) spinner.style.display = "block";
          
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                  submitBtn.disabled = true;
                  submitBtn.innerHTML = "Sending...";
                }
              });
            }
          
          });
</script>

<!-- Check boxes for select all and users -->
<script>
  document.addEventListener("htmx:afterSwap", function (e) {
    if (e.detail.target.id === "user-checkbox-list") {
      const selectAll = document.getElementById("select-all-users");
      const checkboxes = document.querySelectorAll(".user-checkbox");

      if (selectAll && checkboxes.length > 0) {
        selectAll.addEventListener("change", function () {
          checkboxes.forEach(cb => cb.checked = this.checked);
          updateSelectedSummary();
        });
      }

      checkboxes.forEach(cb => {
        cb.addEventListener("change", updateSelectedSummary);
      });

      updateSelectedSummary();
    }
  });

  function updateSelectedSummary() {
    const checked = document.querySelectorAll(".user-checkbox:checked");
    const summary = document.getElementById("selected-summary");

    if (summary) {
      const count = checked.length;
      summary.textContent = `${count} user${count === 1 ? '' : 's'} selected`;
    }
  }

  // Initial run for when page first loads
  document.addEventListener("DOMContentLoaded", updateSelectedSummary);
</script>

<!-- Drop Zone -->
<script>
  Dropzone.autoDiscover = false;
  let uploadedUrls = [];
  let dz;  // Declare upfront so it's accessible everywhere

  function updateTotalSizeDisplay() {
    if (!dz) return;
    const totalSizeBytes = dz.files.reduce((sum, f) => sum + f.size, 0);
    const totalSizeMB = (totalSizeBytes / (1024 * 1024)).toFixed(2);
    const totalSizeEl = document.getElementById("upload-total-size");
    if (totalSizeEl) {
      totalSizeEl.textContent = totalSizeMB;
    }
  }

  dz = new Dropzone("#image-dropzone", {
    url: document.getElementById("image-dropzone").dataset.url,
    autoProcessQueue: false,
    acceptedFiles: `
      image/jpeg,
      image/png,
      image/gif,
      application/pdf,
      application/msword,
      application/vnd.openxmlformats-officedocument.wordprocessingml.document,
      application/vnd.ms-excel,
      application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
    `.replace(/\s+/g, ""),
    maxFiles: 5,
    maxFilesize: 10,
    addRemoveLinks: true,
    init: function () {
      const submitBtn = document.querySelector('#template-email-form button[type="submit"]');
      const fileListEl = document.getElementById("upload-file-list");

      this.on("addedfile", function (file) {
        if (file.resized) {
          dz.processFile(file);
          return;
        }

        const maxTotalSize = 20 * 1024 * 1024;
        const totalSize = dz.files.reduce((sum, f) => sum + f.size, 0) + file.size;

        if (totalSize > maxTotalSize || dz.files.length > 5) {
          dz.removeFile(file);
          alert("‚ùå Total upload size exceeds 20MB or file count exceeds 5.");
          return;
        }

        updateTotalSizeDisplay();
        submitBtn.disabled = true;

        if (!file.type.startsWith("image/")) {
          dz.processFile(file);
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.src = e.target.result;

          img.onload = async function () {
            if (!dz.files.includes(file)) return;

            const canvas = document.createElement("canvas");
            const maxWidth = 1200;
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            const picaResizer = pica();
            await picaResizer.resize(img, canvas);
            const blob = await picaResizer.toBlob(canvas, file.type, 0.9);

            const resizedFile = new File([blob], file.name, { type: file.type });
            resizedFile.resized = true;

            dz.removeFile(file);
            dz.addFile(resizedFile);
          };
        };
        reader.readAsDataURL(file);
      });

      this.on("success", function (file, response) {
        if (response.url) {
          uploadedUrls.push(response.url);
          document.getElementById("uploaded_file_urls").value = JSON.stringify(uploadedUrls);

          const icon = file.type.startsWith("image/")
            ? "üñºÔ∏è"
            : file.type.includes("pdf")
              ? "üìÑ"
              : "üìé";

          const li = document.createElement("li");
          li.textContent = `${icon} ${file.name}`;
          fileListEl.appendChild(li);
        }

        if (dz.getUploadingFiles().length === 0 && dz.getQueuedFiles().length === 0) {
          submitBtn.disabled = false;
        }
      });

      this.on("removedfile", function (file) {
        updateTotalSizeDisplay();
        uploadedUrls = uploadedUrls.filter(url => !url.includes(file.name));
        document.getElementById("uploaded_file_urls").value = JSON.stringify(uploadedUrls);

        [...fileListEl.children].forEach(child => {
          if (child.textContent.includes(file.name)) child.remove();
        });

        if (dz.getUploadingFiles().length === 0 && dz.getQueuedFiles().length === 0) {
          submitBtn.disabled = false;
        }
      });

      this.on("error", function () {
        submitBtn.disabled = false;
      });
    }
  });
</script>

<!-- Alert Messages fade out -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const alerts = document.querySelectorAll(".alert");

    alerts.forEach(alert => {
      setTimeout(() => {
        alert.classList.add("fade"); // Bootstrap fade
        alert.classList.remove("show");

        // Remove from DOM after fade transition completes (500ms)
        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 500);
      }, 5000); // Show for 5 seconds
    });
  });
</script>