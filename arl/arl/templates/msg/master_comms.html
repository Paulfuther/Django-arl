{% extends "../base/base.html" %}
{% block title %}Communications{% endblock %}
{% block template %}

{% include "../base/navbar.html" %}



<style>
/* ===== Sidebar (desktop) ===== */
#commsNav {
  min-height: 100vh;
  border-right: 1px solid #dee2e6;
  background: #fff;
  padding: .75rem .5rem;
}
.sidebar-legend {
  font-size: .7rem;
  letter-spacing: .05em;
  line-height: 1.1;
  text-transform: uppercase;
  color: #6c757d;
  margin-bottom: 1rem;
}
.comms-nav-link {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: .5rem;
  border-radius: .5rem;
  color: inherit;
  text-decoration: none;
}
.comms-nav-link .material-symbols-outlined {
  font-size: 28px;
  line-height: 1;
}
.comms-nav-link.active,
.comms-nav-link:hover {
  color: #0d6efd;
  background: #f1f5ff;
}

/* ===== Mobile nav (icons across top) ===== */
#commsNavMobile .comms-nav-link {
  padding: .5rem;
  border-radius: .5rem;
  text-decoration: none;
  color: inherit;
}
#commsNavMobile .comms-nav-link.active,
#commsNavMobile .comms-nav-link:hover {
  color: #0d6efd;
  background: #f1f5ff;
}
</style>

<div class="container mb-2" style="height: 95vh;">
  <div class="row justify-content-center pt-5 mt-5"></div>
  <div class="row justify-content-center">

    <!-- ===== Desktop Sidebar ===== -->
    <aside class="d-none d-lg-block col-lg-1 px-0">
      <div id="commsNav" class="d-flex flex-column align-items-center py-3">
        <div class="sidebar-legend fw-semibold mb-3">
          <div>Comm</div><div>Center</div>
        </div>
        <nav class="nav flex-column align-items-center" role="tablist" aria-orientation="vertical">
          {% if can_send_email %}
            <a class="comms-nav-link {% if active_tab == 'email' %}active{% endif %}" 
               data-bs-toggle="tab" href="#email" role="tab" data-title="Email">
              <i class="material-symbols-outlined">mail</i>
            </a>
          {% endif %}
          {% if can_send_sms %}
            <a class="comms-nav-link {% if active_tab == 'sms' %}active{% endif %}" 
               data-bs-toggle="tab" href="#sms" role="tab" data-title="SMS">
              <i class="material-symbols-outlined">sms</i>
            </a>
          {% endif %}
          {% if can_send_docusign %}
            <a class="comms-nav-link {% if active_tab == 'docusign' %}active{% endif %}" 
               data-bs-toggle="tab" href="#docusign" role="tab" data-title="DSign">
              <i class="material-symbols-outlined">draw</i>
            </a>
          {% endif %}
          {% if can_send_whatsapp %}
            <a class="comms-nav-link {% if active_tab == 'whatsapp' %}active{% endif %}" 
               data-bs-toggle="tab" href="#whatsapp" role="tab" data-title="WhatsApp">
              <i class="material-symbols-outlined">chat</i>
            </a>
          {% endif %}
        </nav>
      </div>
    </aside>

    <!-- ===== Mobile Top Nav ===== -->
    <div id="commsNavMobile" class="d-flex d-lg-none justify-content-around border-bottom py-2">
      {% if can_send_email %}
        <a class="comms-nav-link {% if active_tab == 'email' %}active{% endif %}" data-bs-toggle="tab" href="#email" role="tab" data-title="Email">
          <i class="material-symbols-outlined">mail</i>
        </a>
      {% endif %}
      {% if can_send_sms %}
        <a class="comms-nav-link {% if active_tab == 'sms' %}active{% endif %}" data-bs-toggle="tab" href="#sms" role="tab" data-title="SMS">
          <i class="material-symbols-outlined">sms</i>
        </a>
      {% endif %}
      {% if can_send_docusign %}
        <a class="comms-nav-link {% if active_tab == 'docusign' %}active{% endif %}" data-bs-toggle="tab" href="#docusign" role="tab" data-title="DSign">
          <i class="material-symbols-outlined">draw</i>
        </a>
      {% endif %}
      {% if can_send_whatsapp %}
        <a class="comms-nav-link {% if active_tab == 'whatsapp' %}active{% endif %}" data-bs-toggle="tab" href="#whatsapp" role="tab" data-title="WhatsApp">
          <i class="material-symbols-outlined">chat</i>
        </a>
      {% endif %}
    </div>

    <!-- ===== Content ===== -->
    <section class="col-12 col-lg-11">
      <div class="tab-content mt-2" id="commsTabContent">
        {% if can_send_email %}
          <div id="email" class="tab-pane fade {% if active_tab == 'email' %}show active{% endif %}">
            {% include "msg/template_email_form.html" %}
          </div>
        {% endif %}
        {% if can_send_sms %}
          <div id="sms" class="tab-pane fade {% if active_tab == 'sms' %}show active{% endif %}">
            {% include "msg/sms_form.html" %}
          </div>
        {% endif %}
        {% if can_send_docusign %}
          <div id="docusign" class="tab-pane fade {% if active_tab == 'docusign' %}show active{% endif %}">
            {% include "dsign/name_email_form.html" %}
          </div>
        {% endif %}
        {% if can_send_whatsapp %}
          <div id="whatsapp" class="tab-pane fade {% if active_tab == 'whatsapp' %}show active{% endif %}">
            {% include "msg/whatsapp_form.html" %}
          </div>
        {% endif %}
      </div>
    </section>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Handle active tab from server or URL hash
  const hash = window.location.hash;
  const selector = hash && document.querySelector(`[data-bs-toggle="tab"][href="${hash}"]`)
    ? `[data-bs-toggle="tab"][href="${hash}"]`
    : `[data-bs-toggle="tab"][href="#{{ active_tab|default:'email' }}"]`;
  const triggers = document.querySelectorAll(selector);
  triggers.forEach(el => new bootstrap.Tab(el).show());

  // Tooltips (desktop only)
  const links = document.querySelectorAll('#commsNav a[data-title]');
  links.forEach(el => {
    new bootstrap.Tooltip(el, {
      title: el.dataset.title,
      placement: 'right',
      trigger: 'hover focus'
    });
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Target both side (desktop) and top (mobile) navs
  const tipTargets = document.querySelectorAll('#commsNav a[data-title], #commsNavMobile a[data-title]');
  const tipMap = new WeakMap();

  // Helper: hide all
  function hideAllTips() {
    tipTargets.forEach(el => tipMap.get(el)?.hide());
  }

  tipTargets.forEach(el => {
    // Remove native title to avoid browser tooltip
    const titleText = el.getAttribute('data-title') || '';
    el.removeAttribute('title');

    // Choose placement: right for desktop sidebar, bottom for mobile top bar
    const placement = el.closest('#commsNavMobile') ? 'bottom' : 'right';

    const tt = new bootstrap.Tooltip(el, {
      title: titleText,
      placement,
      trigger: 'manual',
      container: 'body',
      boundary: 'window',
      delay: 0
    });
    tipMap.set(el, tt);

    let mobileHideTimer = null;

    // Desktop hover/focus
    el.addEventListener('mouseenter', () => { if (!('ontouchstart' in window)) { hideAllTips(); tt.show(); }});
    el.addEventListener('mouseleave', () => { if (!('ontouchstart' in window)) { tt.hide(); }});
    el.addEventListener('focusin',   () => { if (!('ontouchstart' in window)) { hideAllTips(); tt.show(); }});
    el.addEventListener('focusout',  () => { if (!('ontouchstart' in window)) { tt.hide(); }});

    // Mobile tap behavior
    el.addEventListener('touchstart', (e) => {
      // prevent accidental double-trigger from also firing mouse events
      e.stopPropagation();
      hideAllTips();
      tt.show();
      clearTimeout(mobileHideTimer);
      mobileHideTimer = setTimeout(() => tt.hide(), 1500);
    }, {passive: true});

    // On click: switch tab, then blur & hide to prevent sticking
    el.addEventListener('click', () => {
      setTimeout(() => { el.blur(); tt.hide(); }, 0);
    });
  });

  // Hide all tooltips when a tab is shown (desktop or mobile)
  document.addEventListener('shown.bs.tab', hideAllTips);

  // Hide on scroll (useful on mobile)
  window.addEventListener('scroll', hideAllTips, { passive: true });

  // Optional: hide on any outside tap (mobile)
  document.body.addEventListener('touchstart', (e) => {
    if (![...tipTargets].some(el => el.contains(e.target))) hideAllTips();
  }, {passive: true});
});
</script>

{% endblock %}