{% extends "../base/base.html" %}
{% block title %}Twilio Message Summary{% endblock %}

{% block template %}
{% include "../base/navbar.html" %}
{% load crispy_forms_tags %}

<head>
    <!-- jQuery (required for DataTables) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css"/>

    <!-- DataTables JS -->
    <script type="text/javascript"
            src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
</head>

<style>
                    /* Centering the loader */
                .loading-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100px;
                }

                /* The bouncing dots */
                .loading-bounce {
                    display: flex;
                    justify-content: space-between;
                    width: 50px;
                }

                .loading-bounce div {
                    width: 12px;
                    height: 12px;
                    background-color: #007bff; /* Bootstrap primary blue */
                    border-radius: 50%;
                    animation: loadingBounce 1.5s infinite ease-in-out;
                }

                .loading-bounce div:nth-child(1) {
                    animation-delay: 0s;
                }

                .loading-bounce div:nth-child(2) {
                    animation-delay: 0.2s;
                }

                .loading-bounce div:nth-child(3) {
                    animation-delay: 0.4s;
                }

                /* Animation */
                @keyframes loadingBounce {
                    0%, 80%, 100% {
                        transform: scale(0);
                    }
                    40% {
                        transform: scale(1);
                    }
                }
</style>



<div class="container mb-2" style="height: 95vh;">
    <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-10 col-xl-10">
            <legend class="border-bottom mb-4">Message Cost Summary</legend>
            <div id="loading-spinner" class="loading-container">
                <div class="loading-bounce">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>

        <div id="content" style="display: none;">
   
            <table id="sms-summary-table" class="display responsive " style="width:100%">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>SMS Cost</th>
                        <th>Calls Cost</th>
                        <th>Authy SMS</th>
                        <th>Authy Calls</th>
                        <th>Verify SMS</th>
                        <th>Verify WhatsApp</th>
                        <th>Carrier Fees</th>
                        <th>Total Cost</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

        </div>

        </div>
        </div>
        </div>


<script>
    $(document).ready(function () {
    $('#loading-spinner').show();
    $('#content').hide();

    // Initialize DataTable
    let dataTable = $("#sms-summary-table").DataTable({
        paging: true,
        searching: true,
        ordering: true,
        responsive: true,
        scrollX: true,
        info: true,
        lengthMenu: [5, 10, 25, 50, 100],
        order: [[0, "desc"]],
        columns: [
                { title: "Month" },
                { title: "SMS Cost", className: "text-end" },
                { title: "Calls Cost", className: "text-end" },
                { title: "Authy SMS", className: "text-end" },
                { title: "Authy Calls", className: "text-end" },
                { title: "Verify SMS", className: "text-end" },
                { title: "Verify WhatsApp", className: "text-end" },
                { title: "Carrier Fees", className: "text-end" },
                { title: "Total Cost", className: "text-end fw-bold" },
            ]
    });

    // Start the task and fetch the task ID
    $.ajax({
        url: "{% url 'fetch_twilio_data' %}",
        method: "GET",
        success: function (data) {
            console.log("üöÄ Task started with ID:", data.task_id);
            pollTaskStatus(data.task_id);
        },
        error: function () {
            $('#loading-spinner').hide();
            alert("Failed to start the task. Please try again.");
        }
    });

    function pollTaskStatus(taskId) {
        $.ajax({
            url: `/get-task-status/${taskId}/`,
            type: "GET",
            success: function (response) {
                console.log("üì° Task Status Response:", response);

                if (!response || !response.result) {
                    console.warn("‚ö†Ô∏è No data received. Retrying...");
                    setTimeout(() => pollTaskStatus(taskId), 2000);
                    return;
                }

                let result = response.result;

                if (!result.sms_summary || !Array.isArray(result.sms_summary)) {
                    console.warn("‚ö†Ô∏è No SMS Summary Data. Setting default empty list.");
                    result.sms_summary = [];
                }

                console.log("‚úÖ Processing SMS Summary:", result.sms_summary);
                processSmsSummary(result.sms_summary);
            },
            error: function (xhr, status, error) {
                console.error("‚ùå Error fetching task status:", error);
                setTimeout(() => pollTaskStatus(taskId), 2000);
            }
        });
    }

    function processSmsSummary(smsSummary) {
        dataTable.clear(); // Clear existing data

        if (smsSummary.length === 0) {
            console.warn("‚ö†Ô∏è No SMS summary data to display.");
            $('#sms-summary-message').html("<div class='alert alert-warning'>No data available</div>");
            return;
        }

        smsSummary.forEach(entry => {
                dataTable.row.add([
                    entry.date_sent,
                    `$${parseFloat(entry.sms_price || 0).toFixed(2)}`,
                    `$${parseFloat(entry.calls_price || 0).toFixed(2)}`,
                    `$${parseFloat(entry.authy_sms_price || 0).toFixed(2)}`,
                    `$${parseFloat(entry.authy_calls_price || 0).toFixed(2)}`,
                    `$${parseFloat(entry.verify_sms_price || 0).toFixed(2)}`,
                    `$${parseFloat(entry.verify_whatsapp_price || 0).toFixed(2)}`,
                    `$${parseFloat(entry.carrier_fees || 0).toFixed(2)}`,
                    `<strong>$${parseFloat(entry.total_price || 0).toFixed(2)}</strong>`
                ]);
            });
        dataTable.draw();
        console.log("üìä Table updated successfully.");
        $('#loading-spinner').hide();
        $('#content').show();
    }
});
    </script>
{% endblock %}

