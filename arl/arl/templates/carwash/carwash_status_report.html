{% extends "../base/base.html" %}
{% block title %}Carwash Status Report{% endblock %}

{% block template %}
{% include "../base/navbar.html" %}

<style>
    /* âœ… Small font for date & time on mobile */
    .date-time {
        font-size: 0.85rem;
        white-space: nowrap;
    }

    /* âœ… Status Indicator (Green = Open, Red = Closed) */
    .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-left: 8px;
    }
    
    .status-open {
        background-color: green;
    }
    
    .status-closed {
        background-color: red;
    }
</style>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <legend class="border-bottom mb-4">Carwash Status Report</legend>

            <table class="table table-bordered">
                <tbody>
                    {% for entry in data %}
                        <!-- âœ… Store Header Row with Corrected Status Dot -->
                        <tr class="table-primary">
                            <td colspan="4">
                                <strong>Store {{ entry.store_number }}</strong>

                                <!-- âœ… Find the last known status entry -->
                                {% with last_entry=entry.durations|last %}
                                    {% if last_entry and last_entry.opened_at %}
                                        <span class="status-dot float-end status-open"></span> <!-- ðŸŸ¢ OPEN -->
                                    {% else %}
                                        <span class="status-dot float-end status-closed"></span> <!-- ðŸ”´ CLOSED -->
                                    {% endif %}
                                {% endwith %}
                            </td>
                        </tr>

                        <!-- âœ… Table Headers -->
                        <tr>
                            <th>Closed At</th>
                            <th>Opened At</th>
                            <th>Duration</th>
                            <th>Reason</th>
                        </tr>

                        {% for duration in entry.durations %}
                            <tr>
                                <!-- âœ… Closed Date & Time -->
                                <td>
                                    <strong class="date-time">{{ duration.closed_at|slice:":10" }}</strong><br>
                                    <span class="text-muted date-time">{{ duration.closed_at|slice:"11:" }}</span>
                                </td>
                                
                                <!-- âœ… Opened Date & Time -->
                                <td>
                                    {% if duration.opened_at %}
                                        <strong class="date-time">{{ duration.opened_at|slice:":10" }}</strong><br>
                                        <span class="text-muted date-time">{{ duration.opened_at|slice:"11:" }}</span>
                                    {% else %}
                                        <span class="text-danger">Still Closed</span>
                                    {% endif %}
                                </td>
                                
                                <td>{{ duration.duration_closed }}</td>
                                <td>{{ duration.reason }}</td>
                            </tr>
                        {% endfor %}

                        <!-- âœ… Monthly Summary Section -->
                        {% if entry.monthly_summary %}
                            <tr class="table-light">
                                <td colspan="4"><strong>Monthly Summary</strong></td>
                            </tr>
                            <tr>
                                <th>Month</th>
                                <th colspan="3">Total Closed Time</th>
                            </tr>
                            {% for month, total in entry.monthly_summary.items %}
                                <tr>
                                    <td class="date-time"><strong>{{ month }}</strong></td>
                                    <td colspan="3">{{ total }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}