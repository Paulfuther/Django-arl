{% extends "../base/base.html" %}
{% block title %}HR Dashboard{% endblock %}
{% block template %}

{% include "../base/navbar.html" %}
{% load crispy_forms_tags %}


<style>
/* ========== General ========== */
.placeholder-light::placeholder { color: #999 !important; font-style: italic; }
.mobile-btn { font-size: 14px; padding: 6px 12px; border-radius: 8px; }

/* ========== Grids ========== */
.card-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
@media (min-width: 768px) { .card-grid { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 992px) { .card-grid { grid-template-columns: repeat(3, 1fr); } }

.group-checkbox-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: .5rem; margin-top: .5rem;
}
.group-checkbox-grid .form-check { margin-bottom: 0; }

/* ========== Cards ========== */
.user-card, .template-card, .invite-card {
  background: #fff; border: 1px solid #dee2e6; border-radius: .5rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
}
.user-card { padding: 1rem; margin-bottom: 1rem; }
.template-card { padding: 1rem; }
.invite-card {
  display: grid; grid-template-columns: 1fr auto; align-items: center;
  gap: 1rem; padding: 1rem; font-size: 14px;
}
.template-meta { font-size: .85rem; color: #666; }
.invite-info { font-size: 14px; }
.invite-actions { display: flex; flex-direction: column; gap: .4rem; }
.invite-actions .btn { font-size: 13px; padding: 6px 10px; white-space: nowrap; }

/* ========== Tabs (Desktop base) ========== */
#hrTabs.nav-tabs {
  display: flex; flex-wrap: wrap; gap: .5rem; justify-content: flex-start;
  border-bottom: 1px solid var(--bs-border-color);
}
#hrTabs .nav-item { flex: 0 0 auto; }
#hrTabs .nav-link { font-size: 1rem; padding: .5rem .9rem; line-height: 1.2; text-align: center; white-space: normal; }

/* ========== Tables (Docs list) ========== */
.docs-table { table-layout: fixed; width: 100%; border-collapse: collapse; }
.docs-table th, .docs-table td { white-space: normal; vertical-align: middle; padding: .75rem; }
.text-wrap { overflow-wrap: anywhere; word-break: break-word; }

/* Document filename wraps early */
.doc-name { overflow-wrap: anywhere; word-break: break-word; white-space: normal; max-width: 180px; }

/* Action column stays compact and aligned */
.actions-col { white-space: nowrap; width: 1%; text-align: right; }
.actions-col .btn { display: inline-block; max-width: 100%; }

/* Upload date size */
.upload-date { font-size: .85rem; }

/* ========== Employee header (accordion button content) ========== */
.emp-btn { transition: none; }           /* stop hover jiggle */
.emp-btn:focus { box-shadow: none; outline: none; }
.emp-head { display: flex; flex-direction: column; min-width: 0; }
.emp-name { font-weight: 600; line-height: 1.2; }
.emp-email { color: #6c757d; font-size: .9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.accordion-button::after { flex: 0 0 auto; } /* caret doesn't steal width */

/* ========== Card headers with title + form ========== */
.header-flex { display: flex; align-items: center; justify-content: space-between; gap: .75rem; flex-wrap: wrap; }
.header-title { font-weight: 600; line-height: 1.2; flex: 1 1 48%; min-width: 220px; word-break: break-word; }
.header-form { flex: 0 0 auto; }

/* ========== Mobile tweaks ========== */
@media (max-width: 576px) {
  .mobile-btn { font-size: 12px; padding: 4px 10px; }
  .invite-card { grid-template-columns: 1fr; }
  .invite-actions { flex-direction: row; flex-wrap: wrap; margin-top: .75rem; }
  .invite-actions .btn { flex: 1 1 auto; }
  .docs-table th, .docs-table td { padding: .5rem; }
  .upload-date { font-size: .75rem; }
  .emp-email { white-space: normal; }      /* allow wrapping on small screens */

  /* Tabs: two per row, no clipping */
  #hrTabs.nav-tabs { display: flex; flex-wrap: wrap; gap: 0; width: 100%; overflow: visible; }
  #hrTabs .nav-item { flex: 0 0 50%; max-width: 50%; box-sizing: border-box; }
  #hrTabs .nav-link { display: block; width: 100%; padding: .5rem .25rem; font-size: .95rem; }
}

/* ========== Very small screens ========== */
@media (max-width: 480px) {
  .header-title { flex-basis: 100%; }
  .header-form { width: 100%; }
  .header-form .form-control { width: 100%; }
}
</style>
<style>
  /* Make HR tabs fit in a single row and allow label wrapping */
  #hrTabs.nav-tabs {
    display: flex;
    flex-wrap: nowrap;         /* keep one row */
    width: 100%;
    gap: 0;                    /* avoid extra spacing pushing tabs off */
  }
  #hrTabs .nav-item {
    flex: 1 1 0;               /* equal widths across the row */
    min-width: 0;              /* allow the link to shrink */
  }
  #hrTabs .nav-link {
    display: block;
    text-align: center;
    white-space: normal;       /* allow wrapping to multiple lines */
    line-height: 1.2;
    padding: .5rem .4rem;      /* tighter padding */
    font-size: .95rem;         /* slightly smaller to fit more text */
  }

  /* On very small screens, shrink a touch more */
  @media (max-width: 576px) {
    #hrTabs .nav-link {
      font-size: .85rem;
      padding: .45rem .35rem;
    }
  }
</style>

<div class="container mb-2" style="height: 95vh;">
  <div class="row justify-content-center pt-5 mt-5"></div>
  <div class="row justify-content-center">
     
      <legend>HR Dashboard</legend>
{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

      <ul class="nav nav-tabs" id="hrTabs">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'docusign' %}active{% endif %}" data-bs-toggle="tab" href="#docusign">DocuSign Templates</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'employees' %}active{% endif %}" data-bs-toggle="tab" href="#employees">Invite New Employee</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'user-roles' %}active{% endif %}" data-bs-toggle="tab" href="#user-roles">User Roles</a>
        </li>
      </ul>

        <!--  Docusign Templates  -->

          <div class="tab-content mt-3">
            <div id="docusign" class="tab-pane fade {% if active_tab == 'docusign' %}show active{% endif %}">
              {% if active_tab == 'docusign' and messages %}
              {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
              {% endfor %}
            {% endif %}
              <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <a href="{% url 'create_new_document_page' %}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary mobile-btn">
                  <i class="fas fa-plus"></i> Create New Document
                </a>
              </div>
              <div class="card-grid mt-3">
                {% for template in templates %}
                <div class="template-card">
                  <div style="font-weight: 600;
                  font-size: 1rem;
                  margin-bottom: 0.25rem;
                  word-break: break-word;">
                    {{ template.template_name }}
                    {% if template.is_new_hire_template %}<span class="ms-2">&#x2705;</span>{% endif %}
                </div>
                  <p class="template-meta"><strong>Created At:</strong> {{ template.created_at }}
                    {% if template.template_status == "Ready to Send" %}
                    <span class="badge bg-success">{{ template.template_status }}</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">{{ template.template_status }}</span>
                  {% endif %}
                  </p>
                  <div class="template-actions">
                    <a href="{% url 'edit_document_page' template.template_id %}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary mobile-btn">Edit</a>
                  </div>

                  <form method="post" action="{% url 'set_new_hire_template' template.id %}" class="mt-2">
                    {% csrf_token %}
                  
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" name="is_new_hire_template" id="newHireCheckbox" onchange="this.form.submit()" {% if template.is_new_hire_template %}checked{% endif %}>
                      <label class="form-check-label" for="newHireCheckbox">
                        Mark as New Hire File
                      </label>
                    </div>
                  
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="is_in_app_signing_template" id="inAppCheckbox" onchange="this.form.submit()" {% if template.is_in_app_signing_template %}checked{% endif %}>
                      <label class="form-check-label" for="inAppCheckbox">
                        In-App Signing Template
                      </label>
                    </div>

                    <!-- Mark as Company Document -->
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" name="is_company_document" id="companyDocCheckbox" onchange="this.form.submit()" {% if template.is_company_document %}checked{% endif %}>
                      <label class="form-check-label" for="companyDocCheckbox">
                        Mark as Company Document
                      </label>
                  </div>
                  
                  </form>

                </div>
                {% empty %}<p>No templates found.</p>{% endfor %}
              </div>
            </div>
          

        <!-- Invite New Employee -->

          <div id="employees" class="tab-pane fade {% if active_tab == 'employees' %}show active{% endif %}">
            <h4 class="mb-3">Invite a New Hire</h4>
            {% if active_tab == 'employees' and messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
            <div class="card shadow-sm p-3 p-md-4 mb-4">
              <form method="post">
                {% csrf_token %}
                {{ form|crispy }}
                
                  <button type="submit" class="btn btn-outline-primary mobile-btn mt-3">Invite</button>
                
              </form>
            </div>
            <h4 class="mb-3">Pending Invitations</h4>
            {% if pending_invites %}
            <div class="invite-grid">
              {% for invite in pending_invites %}
              <div class="invite-card">
                <div class="invite-info">
                  <strong>{{ invite.name }}</strong><br>
                  <span>{{ invite.email }}</span><br>
                  <span class="text-muted">{{ invite.get_role_display }}</span><br>
                  <span class="text-muted">Sent: {{ invite.created_at|date:"Y-m-d H:i" }}</span>
                </div>
                <div class="invite-actions">
                  <a href="{{ invite.get_invite_link }}" target="_blank" class="btn btn-sm btn-outline-primary">Copy Link</a>
                  <a href="{% url 'resend_invite' invite.id %}" class="btn btn-sm btn-warning">Resend</a>
                  <a href="{% url 'cancel_invite' invite.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to cancel this invite?');">Cancel</a>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}<p class="text-muted">No pending invitations.</p>{% endif %}
          </div>

        <!--   End of Invite. -->

        <!-- Getr and update roles for all employees  -->

        <div id="user-roles" class="tab-pane fade">
          <legend class="mb-3">User Roles</legend>
            <form method="get" hx-get="{% url 'search_user_roles' %}" hx-target="#user-role-table">
              <input type="text" name="query" placeholder="Search users..." class="form-control" />
              <button type="submit" class="btn btn-outline-primary mobile-btn mt-2 mt-2">Search</button>
            </form>
      
            <div id="user-role-table" class="mt-3">
              {% include "user/hr/partials/user_role_list.html" %}
            </div>
        </div>
        
        <!--    End of roles.  -->

       <!-- ðŸ—‚ Employee Documents (HR-only) -->
        <div id="employee-docs" class="tab-pane fade {% if active_tab == 'employee_docs' %}show active{% endif %}">
          
            <!-- Upload panel -->
           
            <!-- ðŸ” Search for Employee to Upload Documents -->
              <div class="card mb-3" id="upload-starter">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <strong class="flex-grow-1" style="min-width:220px; line-height:1.2;">
                      Upload Employee Documents
                    </strong>
                    <form class="d-flex gap-2 w-100"
                          hx-get="{% url 'employee_quick_search' %}"
                          hx-target="#upload-search-results"
                          hx-swap="innerHTML">
                      <input type="text" name="q" class="form-control form-control-sm"
                            placeholder="Search by nameâ€¦" required>
                      <button class="btn btn-sm btn-outline-primary">Search</button>
                    </form>
                  </div>
                </div>
                <div class="card-body" id="upload-search-results">
                  <span class="text-muted small">Enter a nameâ€¦</span>
                </div>
              </div>

            <!-- Upload form card (hidden until employee chosen) -->
<div class="card mb-3 d-none" id="upload-form-card">
  <div class="card-body">
    <h5 class="card-title mb-3">Upload Document</h5>
    <form id="employee-upload-form" method="post" enctype="multipart/form-data" action="{% url 'upload_employee_documents' %}">
      {% csrf_token %}
      <input type="hidden" name="user_id" id="upload-user-id">

      <!-- Chosen employee pill -->
      <div class="mb-3" id="chosen-emp-pill" style="display:none;">
        <span class="badge text-bg-light p-2">
          Uploading for: <span id="chosen-emp-name" class="fw-semibold"></span>
          <span class="text-muted">(<span id="chosen-emp-email"></span>)</span>
        </span>
        <button type="button" class="btn btn-sm btn-link ms-2" onclick="clearChosenEmployee()">Change</button>
      </div>

      <!-- Fields -->
      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label class="form-label">Document Title</label>
          <input type="text" name="document_title" class="form-control" placeholder="e.g., Work Permit, SIN Letter" required>
        </div>
        <div class="col-12">
          <label class="form-label">Notes (optional)</label>
          <textarea name="notes" rows="2" class="form-control" placeholder="Any notesâ€¦"></textarea>
        </div>
        <div class="col-12">
          <label class="form-label">File</label>
          <input type="file" name="file" class="form-control"
                accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.heic,.heif,.txt,.csv,.rtf,.webp,application/pdf,image/*" required>
        </div>
      </div>

      <!-- Buttons + spinner -->
      <div class="mt-3 d-flex gap-2 align-items-center">
        <button id="upload-btn" class="btn btn-sm btn-outline-primary" type="submit">Upload</button>
        <div id="upload-spinner" class="spinner-border spinner-border-sm text-primary" role="status" style="display:none;">
          <span class="visually-hidden">Uploading...</span>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary rounded-0 px-3 py-1"
                onclick="clearChosenEmployee()">Cancel</button>
      </div>
    </form>
  </div>
</div>
              <!--   End of Upload Panel. -->

              <!-- Search panel -->
               <div class="card mt-3">
                <div class="card-header">
                  <strong class="d-block mb-2">Search Employee Documents</strong>
                  <form class="d-flex gap-2 w-100"
                        method="get"
                        hx-get="{% url 'employee_docs_search' %}"
                        hx-target="#employee-doc-results"
                        hx-swap="innerHTML">
                    <input name="doc_q" value="{{ doc_q }}" 
                          class="form-control form-control-sm"
                          placeholder="Search by nameâ€¦">
                    <button class="btn btn-sm btn-outline-primary">Search</button>
                  </form>
                </div>

                <div class="card-body p-0" id="employee-doc-results">
                  {% include "user/hr/partials/employee_doc_list.html" %}
                </div>
              </div>
            <!-- End of Search Panel. -->

        </div>
            <!--   End.   -->

             
      </div>

</div>
<!--   End of Employee Docs tab.  -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const activeTab = "{{ active_tab|default:'docusign' }}";
    if (activeTab) {
      const triggerTab = document.querySelector(`a[data-bs-toggle="tab"][href="#${activeTab}"]`);
      if (triggerTab) {
        const tab = new bootstrap.Tab(triggerTab);
        tab.show();
      }
    }
  });
</script>
<script>
  function chooseEmployeeForUpload(id, name, email) {
    document.getElementById('upload-user-id').value = id;
    document.getElementById('chosen-emp-name').textContent = name;
    document.getElementById('chosen-emp-email').textContent = email;
    document.getElementById('chosen-emp-pill').style.display = '';

    document.getElementById('upload-form-card').classList.remove('d-none');
    document.getElementById('upload-starter').classList.add('d-none');
  }

  function clearChosenEmployee() {
    document.getElementById('upload-user-id').value = '';
    document.getElementById('chosen-emp-pill').style.display = 'none';
    document.getElementById('upload-form-card').classList.add('d-none');
    document.getElementById('upload-starter').classList.remove('d-none');
  }
</script>

<script>
document.getElementById("employee-upload-form").addEventListener("submit", function() {
  const btn = document.getElementById("upload-btn");
  const spinner = document.getElementById("upload-spinner");

  // Disable upload button + show spinner
  btn.disabled = true;
  btn.textContent = "Uploading...";
  spinner.style.display = "inline-block";
});
</script>
{% endblock %}
